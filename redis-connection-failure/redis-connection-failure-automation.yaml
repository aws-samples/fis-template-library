description: "Simulate Redis connection failure by modifying ElastiCache security groups"
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  tagKey:
    type: String
    description: "Tag key to identify ElastiCache clusters to target"
    default: "FIS-Ready"
  tagValue:
    type: String
    description: "Tag value to identify ElastiCache clusters to target"
    default: "True"
  duration:
    type: String
    description: "Duration of the connection failure in ISO8601 format"
    default: "PT5M"
  region:
    type: String
    description: "AWS Region of the ElastiCache clusters"
    default: "{{global:REGION}}"
  AutomationAssumeRole:
    type: String
    description: "IAM role for the automation execution"
    default: ""

mainSteps:
  - name: getTargetClusters
    action: aws:executeScript
    inputs:
      Runtime: python3.11
      Handler: get_clusters
      Script: |
        import boto3

        def get_clusters(events, context):
            region = events['region']
            tag_key = events['tagKey']
            tag_value = events['tagValue']
            
            elasticache = boto3.client('elasticache', region_name=region)
            target_clusters = []
            
            # Get Redis clusters
            paginator = elasticache.get_paginator('describe_cache_clusters')
            
            for page in paginator.paginate():
                for cluster in page['CacheClusters']:
                    if cluster['Engine'] == 'redis':
                        cluster_id = cluster['CacheClusterId']
                        
                        try:
                            # Get cluster tags
                            tags_response = elasticache.list_tags_for_resource(
                                ResourceName=f"arn:aws:elasticache:{region}:{boto3.client('sts').get_caller_identity()['Account']}:cluster:{cluster_id}"
                            )
                            
                            tags = {tag['Key']: tag['Value'] for tag in tags_response.get('TagList', [])}
                            
                            if tags.get(tag_key) == tag_value:
                                # Get security groups
                                security_groups = cluster.get('SecurityGroups', [])
                                if security_groups:
                                    target_clusters.append({
                                        'cluster_id': cluster_id,
                                        'security_groups': [sg['SecurityGroupId'] for sg in security_groups]
                                    })
                                        
                        except Exception as e:
                            print(f"Error processing cluster {cluster_id}: {str(e)}")
                            continue
                            
            return target_clusters
      InputPayload:
        region: "{{ region }}"
        tagKey: "{{ tagKey }}"
        tagValue: "{{ tagValue }}"
    outputs:
      - Name: targetClusters
        Selector: $.Payload
        Type: MapList
    description: "Find ElastiCache Redis clusters with specified tags"

  - name: disableRedisConnections
    action: aws:executeScript
    onFailure: "step:restoreRedisConnections"
    onCancel: "step:restoreRedisConnections"
    inputs:
      Runtime: python3.11
      Handler: disable_connections
      Script: |
        import boto3

        def disable_connections(events, context):
            region = events['region']
            target_clusters = events['targetClusters']
            
            ec2 = boto3.client('ec2', region_name=region)
            results = []
            modified_rules = []
            
            for cluster_info in target_clusters:
                cluster_id = cluster_info['cluster_id']
                security_groups = cluster_info['security_groups']
                
                for sg_id in security_groups:
                    try:
                        # Get current security group rules
                        response = ec2.describe_security_groups(GroupIds=[sg_id])
                        sg = response['SecurityGroups'][0]
                        
                        # Store original inbound rules for Redis port (6379)
                        redis_rules = []
                        for rule in sg['IpPermissions']:
                            if rule.get('FromPort') == 6379 and rule.get('ToPort') == 6379:
                                redis_rules.append(rule)
                        
                        if redis_rules:
                            # Remove Redis access rules
                            ec2.revoke_security_group_ingress(
                                GroupId=sg_id,
                                IpPermissions=redis_rules
                            )
                            
                            modified_rules.append({
                                'security_group_id': sg_id,
                                'cluster_id': cluster_id,
                                'removed_rules': redis_rules
                            })
                            
                            results.append(f"Disabled Redis connections for cluster {cluster_id}, SG {sg_id}")
                        
                    except Exception as e:
                        results.append(f"Failed to modify SG {sg_id} for cluster {cluster_id}: {str(e)}")
            
            return {
                'modifiedRules': modified_rules,
                'results': results
            }
      InputPayload:
        region: "{{ region }}"
        targetClusters: "{{ getTargetClusters.targetClusters }}"
    outputs:
      - Name: modifiedRules
        Selector: $.Payload.modifiedRules
        Type: MapList
      - Name: results
        Selector: $.Payload.results
        Type: StringList
    description: "Disable Redis connections by removing security group rules"

  - name: waitForDuration
    action: "aws:sleep"
    onFailure: "step:restoreRedisConnections"
    onCancel: "step:restoreRedisConnections"
    inputs:
      Duration: "{{ duration }}"
    description: "Wait for the specified duration while Redis connections are blocked"

  - name: restoreRedisConnections
    action: aws:executeScript
    inputs:
      Runtime: python3.11
      Handler: restore_connections
      Script: |
        import boto3

        def restore_connections(events, context):
            region = events['region']
            modified_rules = events['modifiedRules']
            
            ec2 = boto3.client('ec2', region_name=region)
            results = []
            
            for rule_info in modified_rules:
                sg_id = rule_info['security_group_id']
                cluster_id = rule_info['cluster_id']
                removed_rules = rule_info['removed_rules']
                
                try:
                    # Restore the original rules
                    if removed_rules:
                        ec2.authorize_security_group_ingress(
                            GroupId=sg_id,
                            IpPermissions=removed_rules
                        )
                        results.append(f"Restored Redis connections for cluster {cluster_id}, SG {sg_id}")
                        
                except Exception as e:
                    results.append(f"Failed to restore SG {sg_id} for cluster {cluster_id}: {str(e)}")
            
            return results
      InputPayload:
        region: "{{ region }}"
        modifiedRules: "{{ disableRedisConnections.modifiedRules }}"
    outputs:
      - Name: results
        Selector: $.Payload
        Type: StringList
    description: "Restore Redis connections by adding back security group rules"
    isEnd: true
