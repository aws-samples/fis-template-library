{
  "description": "Apply a deny-all policy to SQS queue to simulate impairment using Lambda",
  "schemaVersion": "0.3",
  "assumeRole": "arn:aws:iam::<YOUR AWS ACCOUNT>:role/<YOUR SSM ROLE NAME>",
  "parameters": {
    "sqsQueueUrl": {
      "type": "String",
      "description": "URL of the SQS queue to impair"
    },
    "sqsQueueArn": {
      "type": "String",
      "description": "ARN of the SQS queue to impair"
    },
    "duration": {
      "type": "String",
      "description": "Duration of the impairment in ISO8601 format",
      "default": "PT10M"
    }
  },
  "mainSteps": [
    {
      "name": "applyDenyAllPolicy",
      "action": "aws:invokeLambdaFunction",
      "onFailure": "step:rollBack",
      "onCancel": "step:rollBack",
      "inputs": {
        "FunctionName": "<YOUR LAMBDA FUNCTION NAME>",
        "Payload": "{\"QueueUrl\": \"{{ sqsQueueUrl }}\", \"QueueArn\": \"{{ sqsQueueArn }}\", \"Action\": \"add\"}"
      }
    },
    {
      "name": "waitForDuration",
      "action": "aws:sleep",
      "onFailure": "step:rollBack",
      "onCancel": "step:rollBack",
      "inputs": {
        "Duration": "{{ duration }}"
      }
    },
    {
      "name": "rollBack",
      "action": "aws:invokeLambdaFunction",
      "inputs": {
        "FunctionName": "<YOUR LAMBDA FUNCTION NAME>",
        "Payload": "{\"QueueUrl\": \"{{ sqsQueueUrl }}\", \"QueueArn\": \"{{ sqsQueueArn }}\", \"Action\": \"remove\"}"
      },
      "isEnd": true
    }
  ]
}
